/* cppsrc/main.cpp */
#include <napi.h>
#include <stdlib.h>
#include <dlfcn.h>
#include "ICClib.h"
#include <string>
#include <iostream>

using namespace std;

ICC_lib * myClass;
//char tryte_str[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

//string doPow(string trytes) {
Napi::String doPow(const Napi::CallbackInfo& info)	{
	Napi::Env env = info.Env();
	if (info.Length() > 1 || !info[0].IsString() ) {
		Napi::TypeError::New(env, "String expected").ThrowAsJavaScriptException();
	}
	Napi::String n_api_trytes = info[0].As<Napi::String>();
	
	string trytes = n_api_trytes.Utf8Value();	
	char nonce[28];
	nonce[27] = '\0';
	myClass->doPow((char*)trytes.c_str(), nonce);	
	string* ret = new string(nonce);
	string ret1 = *ret;
	
	Napi::String returnValue = Napi::String::New(env, ret1);
	
	return returnValue;	
}

string generateAddress(string seed, int index, int security) {
	char address[82];	
	myClass->generateAddress_seed((char*)seed.c_str(),index, security, address);
	address[81] = '\0';
	string* ret = new string(address);
	return *ret;
}

/*Napi::Object deInit(){
	destroy(myClass);
}*/

Napi::Object Init(Napi::Env env, Napi::Object exports) {
	void *handle;

	handle = dlopen("/home/pi/lib/ICC_lib.so", RTLD_LAZY);
	if (handle == NULL) {
		printf("dlopen failed\r\n");
	}

	ICC_lib* (*create)();
	void (*destroy)(ICC_lib*);

	create = (ICC_lib* (*)())dlsym(handle, "create_object");
	destroy	= (void (*)(ICC_lib*))dlsym(handle, "destroy_object");

	myClass	= (ICC_lib*) create();
	
	//string test = "999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999A9RGRKVGWMWMKOLVMDFWJUHNUNYWZTJADGGPZGXNLERLXYWJE9WQHWWBMCPZMVVMJUMWWBLZLNMLDCGDJ999999999999999999999999999999999999999999999999999999YGYQIVD99999999999999999999TXEFLKNPJRBYZPORHZU9CEMFIFVVQBUSTDGSJCZMBTZCDTTJVUFPTCCVHHORPMGCURKTH9VGJIXUQJVHK999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999";

	//printf("%s\n", doPow(test).c_str());
	//printf("%s\n", generateAddress("TESTSEEDTESTSEEDTESTSEEDTESTSEEDTESTSEEDTESTSEEDTESTSEEDTESTSEEDTESTSEEDTESTSEEDT",1,2).c_str());
	
	exports.Set("doPow", Napi::Function::New(env, doPow));
	//exports.Set("deInit", Napi::Function::New(env, deInit));	
	
	return exports;
}

//NODE_API_MODULE(ICC, doPow)
//NODE_API_MODULE(ICC, generateAddress)
NODE_API_MODULE(ICC, Init)